<!DOCTYPE html>
<!--
    *************************************************************************
    * [ ë¼ì´ì„¼ìŠ¤ ë° ì €ì‘ê¶Œ ëª…ì‹œ ]
    *
    * ì†Œìœ ê¶Œ(Ownership): smweb.kr
    * ì œì‘ì(Creator): ê¹€ì¸ì¬ (injae kim)
    * atmntkij@gmail.com
    *
    * [ ì´ìš© ì•½ê´€ ë° ë²•ì  ê³ ì§€ ]
    * ë³¸ ì†ŒìŠ¤ ì½”ë“œì™€ í”„ë¡œê·¸ë¨ ë””ìì¸, ë¡œì§ì€ smweb.krì˜ ì§€ì  ì¬ì‚°ì…ë‹ˆë‹¤.
    * ì €ì‘ê¶Œìì˜ ëª…ì‹œì ì¸ ì„œë©´ í—ˆê°€ ì—†ì´ ë³¸ ì†ŒìŠ¤ ì½”ë“œì˜ ì „ë¶€ ë˜ëŠ” ì¼ë¶€ë¥¼
    * ë¬´ë‹¨ìœ¼ë¡œ ë³µì œ, ìˆ˜ì •, ë°°í¬, íŒë§¤, ê²Œì‹œí•˜ëŠ” ëª¨ë“  í–‰ìœ„ë¥¼ ì—„ê²©íˆ ê¸ˆì§€í•©ë‹ˆë‹¤.
    * 
    * 1. ë¬´ë‹¨ ìˆ˜ì • ê¸ˆì§€: ë³¸ ì½”ë“œë¥¼ ì„ì˜ë¡œ ë³€ê²½í•˜ê±°ë‚˜ íŒŒìƒ ì €ì‘ë¬¼ì„ ë§Œë“œëŠ” í–‰ìœ„ë¥¼ ê¸ˆí•©ë‹ˆë‹¤.
    * 2. ë¬´ë‹¨ ë°°í¬ ê¸ˆì§€: ë³¸ ì½”ë“œë¥¼ ì œ3ìì—ê²Œ ë°°í¬, ê³µìœ , íŒë§¤í•˜ëŠ” í–‰ìœ„ë¥¼ ê¸ˆí•©ë‹ˆë‹¤.
    * 3. ìƒì—…ì  ì´ìš© ê¸ˆì§€: ì €ì‘ê¶Œìì˜ í—ˆë½ ì—†ëŠ” ìƒì—…ì  ì´ìš©ì„ ê¸ˆí•©ë‹ˆë‹¤.
    *
    * ìœ„ ì‚¬í•­ì„ ìœ„ë°˜í•  ê²½ìš° ì €ì‘ê¶Œë²• ë° ê´€ë ¨ ë²•ë ¹ì— ë”°ë¼ ë¯¼í˜•ì‚¬ìƒ ì±…ì„ì„ ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    *
    * Copyright (c) 2026 smweb.kr. All Rights Reserved.
    *************************************************************************
-->
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì´ë¯¸ì§€ ê°¤ëŸ¬ë¦¬ ë·°ì–´ (ê²½ë¡œ ê¸°ì–µ + Chrome ì™„ë²½ í˜¸í™˜)</title>
    <!-- íŒŒì´ì–´í­ìŠ¤ ZIP ë‹¤ìš´ë¡œë“œë¥¼ ìœ„í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ê°€ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: #1a1a1a;
            overflow: hidden;
            height: 100vh;
        }

        .gallery-container {
            position: relative;
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: #000;
        }

        /* ë“œë¡­ì¡´ ì˜ì—­ */
        .drop-zone {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            background: #000;
            z-index: 100;
            transition: all 0.3s ease;
        }

        .drop-zone.hidden {
            display: none;
        }

        .drop-area {
            width: 20%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-right: 2px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .drop-area.dragging {
            background: rgba(33, 150, 243, 0.2);
            border: 3px dashed rgba(33, 150, 243, 0.8);
        }

        .drop-message {
            color: white;
            font-size: 24px;
            text-align: center;
            margin-bottom: 15px;
            pointer-events: none;
        }

        .drop-instruction {
            color: rgba(255, 255, 255, 0.6);
            font-size: 14px;
            text-align: center;
            pointer-events: none;
        }

        /* íˆìŠ¤í† ë¦¬ ì˜ì—­ */
        .history-area {
            width: 80%;
            height: 100%;
            overflow-y: auto;
            padding: 40px;
            background: #0a0a0a;
        }

        .history-title {
            color: white;
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 30px;
            text-align: center;
        }

        .history-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .history-item {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            user-select: none;
        }

        .history-item:hover {
            background: rgba(100, 100, 100, 0.3);
            border-color: rgba(255, 255, 255, 0.3);
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
        }

        .history-item-name {
            color: white;
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 8px;
            word-break: break-word;
            pointer-events: none;
        }

        .history-item-info {
            color: rgba(255, 255, 255, 0.6);
            font-size: 12px;
            margin-bottom: 4px;
            pointer-events: none;
        }

        .history-item-delete {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 59, 48, 0.8);
            border: none;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: all 0.3s ease;
        }

        .history-item:hover .history-item-delete {
            opacity: 1;
        }

        .history-item-delete:hover {
            background: rgba(255, 59, 48, 1);
            transform: scale(1.1);
        }

        .no-history {
            text-align: center;
            color: rgba(255, 255, 255, 0.4);
            font-size: 18px;
            padding: 60px 20px;
        }

        .history-upload {
            margin-top: 30px;
            text-align: center;
        }

        .folder-upload-btn {
            display: inline-block;
            padding: 12px 24px;
            background: rgba(33, 150, 243, 0.8);
            color: #fff;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            border: none;
            font-size: 16px;
        }

        .folder-upload-btn:hover {
            background: rgba(33, 150, 243, 1);
            transform: scale(1.05);
        }

        /* ë©”ì¸ ë·°ì–´ */
        .main-viewer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #imageWrapper {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .gallery-image {
            max-width: 100vw;
            max-height: 100vh;
            width: auto;
            height: auto;
            object-fit: contain;
            transition: opacity 0.3s ease, transform 0.3s ease;
            transform-origin: center center;
            cursor: grab;
        }

        .gallery-image:active {
            cursor: grabbing;
        }

        .gallery-image.fade {
            opacity: 0;
        }

        .zoom-info {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            z-index: 60;
            display: none;
            backdrop-filter: blur(10px);
        }

        .nav-button {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 36px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
        }

        .nav-button:hover {
            background: rgba(255, 255, 255, 0.4);
            transform: translateY(-50%) scale(1.1);
        }

        .prev-button {
            left: 20px;
        }

        .next-button {
            right: 20px;
        }

        /* ì»¨íŠ¸ë¡¤ ì˜ì—­ */
        .control-trigger {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 100px;
            z-index: 49;
        }

        .controls-section {
            position: fixed;
            bottom: 0;
            left: 0;
            background: rgba(0, 0, 0, 0.95);
            width: 100%;
            padding: 20px 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            z-index: 50;
            transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .controls-section.hidden {
            transform: translateY(100%);
        }

        .controls {
            display: flex;
            gap: 15px;
            align-items: center;
            padding: 10px 25px;
            border-radius: 50px;
            background: rgba(255, 255, 255, 0.1);
            flex-wrap: wrap;
            justify-content: center;
        }

        .control-button {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .control-button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }

        .control-button.active {
            background: rgba(76, 175, 80, 0.8);
        }

        .speed-control {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        .speed-button {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .speed-button.active {
            background: rgba(255, 193, 7, 0.8);
        }

        .image-counter {
            color: white;
            font-size: 14px;
            padding: 0 10px;
            font-weight: bold;
        }

        .thumbnail-section {
            position: relative;
            width: 100%;
            padding: 0 60px;
            overflow: hidden;
        }

        .thumbnail-container {
            display: flex;
            gap: 10px;
            padding: 10px 0;
            transition: transform 0.3s ease;
            overflow-x: auto;
            overflow-y: hidden;
            white-space: nowrap;
            scrollbar-width: none;
        }

        .thumbnail-container::-webkit-scrollbar {
            display: none;
        }

        .thumbnail {
            width: 120px;
            height: 80px;
            cursor: pointer;
            border-radius: 8px;
            object-fit: cover;
            border: 3px solid transparent;
            transition: all 0.3s ease;
            opacity: 0.6;
            flex-shrink: 0;
            display: inline-block;
        }

        .thumbnail:hover {
            opacity: 0.8;
            transform: scale(1.05);
        }

        .thumbnail.active {
            border-color: #4CAF50;
            opacity: 1;
            transform: scale(1.1);
        }

        .thumb-nav-button {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.3);
            border: none;
            color: white;
            font-size: 24px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 5;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
        }

        .thumb-nav-button:hover {
            background: rgba(255, 255, 255, 0.5);
            transform: translateY(-50%) scale(1.1);
        }

        .thumb-prev {
            left: 10px;
        }

        .thumb-next {
            right: 10px;
        }

        .fullscreen-button,
        .thumbnail-grid-button {
            background: rgba(255, 152, 0, 0.8);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .thumbnail-grid-button {
            background: rgba(156, 39, 176, 0.8);
        }

        .fullscreen-button:hover,
        .thumbnail-grid-button:hover {
            transform: scale(1.05);
            filter: brightness(1.1);
        }

        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .thumbnail-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 200;
            display: none;
            overflow-y: auto;
            padding: 40px 20px;
            outline: none;
        }

        .thumbnail-modal.active {
            display: block;
        }

        .modal-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.9);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 201;
            backdrop-filter: blur(10px);
        }

        .modal-title {
            color: white;
            font-size: 20px;
            font-weight: bold;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
        }

        .modal-download {
            background: rgba(76, 175, 80, 0.8);
            border: none;
            color: white;
            padding: 10px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .modal-download:hover {
            background: rgba(76, 175, 80, 1);
            transform: scale(1.05);
        }

        .modal-download:disabled {
            background: rgba(100, 100, 100, 0.5);
            cursor: not-allowed;
            transform: none;
        }

        .modal-close {
            background: rgba(255, 59, 48, 0.8);
            border: none;
            color: white;
            padding: 10px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .modal-close:hover {
            background: rgba(255, 59, 48, 1);
            transform: scale(1.05);
        }

        .thumbnail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            max-width: 1600px;
            margin: 80px auto 40px;
        }

        .grid-item {
            position: relative;
            aspect-ratio: 3/5;
            cursor: pointer;
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.3s ease;
            border: 3px solid transparent;
            outline: none;
        }

        .grid-item:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 30px rgba(255, 255, 255, 0.3);
        }

        .grid-item.current {
            border-color: #4CAF50;
            box-shadow: 0 0 20px rgba(76, 175, 80, 0.6);
        }

        .grid-item.focused {
            border-color: #2196F3;
            box-shadow: 0 0 20px rgba(33, 150, 243, 0.8);
            transform: scale(1.05);
            z-index: 10;
        }

        .grid-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .grid-item-number {
            position: absolute;
            top: 8px;
            left: 8px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
        }

        .loading {
            color: white;
            font-size: 18px;
            text-align: center;
            line-height: 1.6;
        }

        
        /* [ì¶”ê°€] ê´‘ê³  ì„¹ì…˜ ìŠ¤íƒ€ì¼ */
        .ad-section {
            width: 100%;
            max-width: 1400px; /* ë¦¬ìŠ¤íŠ¸ ë„ˆë¹„ì™€ ë™ì¼í•˜ê²Œ ë§ì¶¤ */
            margin: 0 auto 40px auto; /* ì•„ë˜ìª½ ì—¬ë°± 40px */
            padding: 20px;
            background: rgba(255, 255, 255, 0.03); /* ë°°ê²½ê³¼ êµ¬ë¶„ë˜ëŠ” ì€ì€í•œ ìƒ‰ìƒ */
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            text-align: center;
            min-height: 120px; /* ê´‘ê³  ë¡œë”© ì „ ë ˆì´ì•„ì›ƒ ë°€ë¦¼ ë°©ì§€ */
        }

        .ad-label {
            color: rgba(255, 255, 255, 0.2);
            font-size: 11px;
            margin-bottom: 10px;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

               
    </style>

    <!-- [ì¶”ê°€] êµ¬ê¸€ ì• ë“œì„¼ìŠ¤ ìŠ¤í¬ë¦½íŠ¸ -->    
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7551517924895708"
     crossorigin="anonymous"></script>

</head>

<body>
    <div class="gallery-container">
        <div class="drop-zone" id="dropZone">
            <div class="drop-area" id="dropArea">
                <div class="drop-message">ğŸ“ í´ë” ë“œë¡­(Firefox Only)</div>
                <div class="drop-instruction">ì—¬ê¸°ì— ë“œë˜ê·¸í•˜ì„¸ìš”</div>
            </div>
            <div class="history-area">




                <!-- [ì¶”ê°€] ìƒë‹¨ ê´‘ê³  ì„¹ì…˜ -->
                <div class="ad-section">
                    <div class="ad-label">Advertisement</div>
                    <!-- êµ¬ê¸€ ì• ë“œì„¼ìŠ¤ ë””ìŠ¤í”Œë ˆì´ ê´‘ê³  ì½”ë“œ -->
                    <ins class="adsbygoogle"
                         style="display:block"
                         data-ad-client="ca-pub-XXXXXXXXXXXXXXXX" 
                         data-ad-slot="1234567890"
                         data-ad-format="auto"
                         data-full-width-responsive="true"></ins>
                    <script>
                         (adsbygoogle = window.adsbygoogle || []).push({});
                    </script>
                </div>
                <!-- // ê´‘ê³  ì„¹ì…˜ ë -->




                <div class="history-title">ğŸ“š ìµœê·¼ ë³¸ í´ë”</div>
                <div class="history-list" id="historyList">
                    <div class="no-history">ì•„ì§ ë³¸ í´ë”ê°€ ì—†ìŠµë‹ˆë‹¤.<br>ì¢Œì¸¡ì— í´ë”ë¥¼ ë“œë˜ê·¸í•´ì£¼ì„¸ìš”.</div>
                </div>

                <div class="history-upload">
                    <button class="folder-upload-btn" id="unifiedUploadBtn">
                        ğŸ“‚ í´ë” ì—´ê¸° (ìµœê·¼ ê²½ë¡œ ê¸°ì–µ. Chrome Only.)
                    </button>
                    <input type="file" id="fallbackFolderInput" webkitdirectory directory multiple hidden>
                </div>
            </div>
        </div>

        <div class="main-viewer">
            <div id="imageWrapper"></div>
            <button class="nav-button prev-button" id="prevBtn" style="display: none;">â€¹</button>
            <button class="nav-button next-button" id="nextBtn" style="display: none;">â€º</button>
        </div>

        <div class="zoom-info" id="zoomInfo">100%</div>
        <div class="control-trigger" id="controlTrigger" style="display: none;"></div>

        <div class="controls-section" style="display: none;" id="controlsSection">
            <div class="controls">
                <button class="control-button" id="autoplayBtn">â–¶ ìë™ì¬ìƒ</button>
                <div class="speed-control">
                    <span style="color: white; font-size: 12px;">ì†ë„:</span>
                    <button class="speed-button active" data-speed="1000">ë¹ ë¦„</button>
                    <button class="speed-button" data-speed="3000">ë³´í†µ</button>
                    <button class="speed-button" data-speed="5000">ëŠë¦¼</button>
                </div>
                <span class="image-counter" id="counter">0 / 0</span>
                <button class="fullscreen-button" id="fullscreenBtn">ğŸ–¥ï¸ ì „ì²´í™”ë©´</button>
                <button class="thumbnail-grid-button" id="thumbnailGridBtn">ğŸï¸ ì „ì²´ì¸ë„¤ì¼</button>
                <button class="control-button" id="uploadBtn">ğŸ“¤ íŒŒì¼ ì—…ë¡œë“œ</button>
            </div>

            <div class="thumbnail-section">
                <button class="thumb-nav-button thumb-prev" id="thumbPrev">â€¹</button>
                <div class="thumbnail-container" id="thumbnailContainer"></div>
                <button class="thumb-nav-button thumb-next" id="thumbNext">â€º</button>
            </div>
        </div>

        <!-- ì¸ë„¤ì¼ ê·¸ë¦¬ë“œ ëª¨ë‹¬ -->
        <div class="thumbnail-modal" id="thumbnailModal" tabindex="-1">
            <div class="modal-header">
                <div class="modal-title">ì „ì²´ ì´ë¯¸ì§€ (ì´ <span id="modalCount">0</span>ê°œ)</div>
                <div class="modal-actions">
                    <button class="modal-download" id="modalDownload" disabled>ğŸ’¾ ì¸ë„¤ì¼ ë‹¤ìš´ë¡œë“œ</button>
                    <button class="modal-close" id="modalClose">âœ• ë‹«ê¸°</button>
                </div>
            </div>
            <div class="thumbnail-grid" id="thumbnailGrid"></div>
        </div>
    </div>

    <script>
        let imageFiles = [];
        let currentIndex = 0;
        let autoplayInterval = null;
        let isAutoplay = false;
        let playSpeed = 3000;
        let hideControlsTimeout = null;
        let zoomLevel = 1;
        let isPanning = false;
        let startX = 0;
        let startY = 0;
        let translateX = 0;
        let translateY = 0;
        let folderHistory = [];
        let currentFolderData = null;
        let thumbnailCache = new Map();
        let focusedGridIndex = -1;
        let currentFolderHandle = null;
        let thumbFolderHandle = null;

        const dropZone = document.getElementById('dropZone');
        const dropArea = document.getElementById('dropArea');
        const historyList = document.getElementById('historyList');
        const imageWrapper = document.getElementById('imageWrapper');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const autoplayBtn = document.getElementById('autoplayBtn');
        const counter = document.getElementById('counter');
        const thumbnailContainer = document.getElementById('thumbnailContainer');
        const controlsSection = document.getElementById('controlsSection');
        const fullscreenBtn = document.getElementById('fullscreenBtn');
        const speedButtons = document.querySelectorAll('.speed-button');
        const thumbPrev = document.getElementById('thumbPrev');
        const thumbNext = document.getElementById('thumbNext');
        const controlTrigger = document.getElementById('controlTrigger');
        const zoomInfo = document.getElementById('zoomInfo');
        const thumbnailGridBtn = document.getElementById('thumbnailGridBtn');
        const uploadBtn = document.getElementById('uploadBtn');
        const thumbnailModal = document.getElementById('thumbnailModal');
        const modalClose = document.getElementById('modalClose');
        const modalDownload = document.getElementById('modalDownload');
        const thumbnailGrid = document.getElementById('thumbnailGrid');
        const modalCount = document.getElementById('modalCount');
        const unifiedUploadBtn = document.getElementById('unifiedUploadBtn');
        const fallbackFolderInput = document.getElementById('fallbackFolderInput');

        // ===============================================
        // [New] IndexedDB Helper for Saving Last Folder
        // ===============================================
        const DB_NAME = 'GallerySettings';
        const STORE_NAME = 'handles';

        function getDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, 1);
                request.onupgradeneeded = (e) => {
                    e.target.result.createObjectStore(STORE_NAME);
                };
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        async function saveLastHandle(handle) {
            try {
                const db = await getDB();
                const tx = db.transaction(STORE_NAME, 'readwrite');
                tx.objectStore(STORE_NAME).put(handle, 'lastDir');
            } catch (e) { console.warn('DB Save Error', e); }
        }

        async function getLastHandle() {
            try {
                const db = await getDB();
                return new Promise((resolve) => {
                    const tx = db.transaction(STORE_NAME, 'readonly');
                    const req = tx.objectStore(STORE_NAME).get('lastDir');
                    req.onsuccess = () => resolve(req.result);
                    req.onerror = () => resolve(null);
                });
            } catch (e) { return null; }
        }

        // [Chrome] í´ë” ì—´ê¸° (ê²½ë¡œ ê¸°ì–µ + ì“°ê¸° ê¶Œí•œ í™•ë³´)
        unifiedUploadBtn.addEventListener('click', async () => {
            if (window.showDirectoryPicker) {
                try {
                    let startInOption = undefined;
                    try {
                        const lastHandle = await getLastHandle();
                        if (lastHandle) startInOption = lastHandle;
                    } catch (e) { }

                    const dirHandle = await window.showDirectoryPicker({
                        mode: 'readwrite',
                        startIn: startInOption
                    });

                    // ì„±ê³µ ì‹œ í•¸ë“¤ ì €ì¥
                    await saveLastHandle(dirHandle);

                    currentFolderHandle = dirHandle;
                    const files = [];
                    await scanDirectoryHandle(dirHandle, files);
                    if (files.length === 0) { alert('ì´ë¯¸ì§€ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return; }
                    currentFolderData = { name: dirHandle.name, timestamp: new Date().toISOString(), count: files.length };
                    loadImages(files);
                    saveFolderHistory();
                } catch (err) {
                    if (err.name !== 'AbortError') { console.error(err); alert('í´ë” ì—´ê¸° ì‹¤íŒ¨: ' + err.message); }
                }
            } else {
                currentFolderHandle = null;
                fallbackFolderInput.click();
            }
        });

        async function scanDirectoryHandle(dirHandle, files) {
            for await (const entry of dirHandle.values()) {
                if (entry.kind === 'file') {
                    if (isImageFile(entry.name)) files.push(await entry.getFile());
                } else if (entry.kind === 'directory') {
                    if (entry.name.toLowerCase() === 'thumb') continue;
                    await scanDirectoryHandle(entry, files);
                }
            }
        }

        // [Firefox/Fallback] í´ë” ì—´ê¸°
        fallbackFolderInput.addEventListener('change', (e) => {
            const files = Array.from(e.target.files).filter(file => isImageFile(file.name));
            if (files.length === 0) { alert('ì´ë¯¸ì§€ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return; }
            let folderName = 'ì„ íƒí•œ í´ë”';
            if (files[0].webkitRelativePath) folderName = files[0].webkitRelativePath.split('/')[0];
            currentFolderData = { name: folderName, timestamp: new Date().toISOString(), count: files.length };
            currentFolderHandle = null;
            loadImages(files);
            saveFolderHistory();
            fallbackFolderInput.value = '';
        });

        // ë“œë˜ê·¸ ì•¤ ë“œë¡­
        dropArea.addEventListener('dragover', (e) => { e.preventDefault(); dropArea.classList.add('dragging'); });
        dropArea.addEventListener('dragleave', () => { dropArea.classList.remove('dragging'); });
        dropArea.addEventListener('drop', async (e) => {
            e.preventDefault(); dropArea.classList.remove('dragging');
            const files = []; currentFolderHandle = null; thumbFolderHandle = null;
            if (e.dataTransfer.items) {
                const items = e.dataTransfer.items;
                for (let i = 0; i < items.length; i++) {
                    if (!currentFolderHandle && items[i].getAsFileSystemHandle) {
                        try { const handle = await items[i].getAsFileSystemHandle(); if (handle && handle.kind === 'directory') currentFolderHandle = handle; } catch (err) { }
                    }
                    const item = items[i].webkitGetAsEntry();
                    if (item) await scanFiles(item, files);
                }
            } else {
                Array.from(e.dataTransfer.files).forEach(file => { if (isImageFile(file.name)) files.push(file); });
            }
            if (files.length === 0) { alert('ì´ë¯¸ì§€ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return; }

            // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì„±ê³µ ì‹œì—ë„ í•¸ë“¤ ì €ì¥ ì‹œë„ (FileSystem API ì§€ì› ì‹œ)
            if (currentFolderHandle) {
                await saveLastHandle(currentFolderHandle);
            }

            let folderPath = 'ì´ë¯¸ì§€ íŒŒì¼';
            try {
                if (files[0].webkitRelativePath) folderPath = files[0].webkitRelativePath.split('/')[0];
                else if (e.dataTransfer.items && e.dataTransfer.items[0]) {
                    const entry = e.dataTransfer.items[0].webkitGetAsEntry();
                    if (entry) folderPath = entry.name;
                }
            } catch (e) { }
            currentFolderData = { name: folderPath, timestamp: new Date().toISOString(), count: files.length };
            loadImages(files);
            saveFolderHistory();
        });

        async function scanFiles(item, files) {
            if (item.isFile) {
                return new Promise((resolve) => { item.file((file) => { if (isImageFile(file.name)) files.push(file); resolve(); }); });
            } else if (item.isDirectory) {
                if (item.name.toLowerCase() === 'thumb') return Promise.resolve();
                const dirReader = item.createReader();
                return new Promise((resolve) => {
                    const readEntries = () => {
                        dirReader.readEntries(async (entries) => {
                            if (entries.length === 0) resolve(); else { for (const entry of entries) await scanFiles(entry, files); readEntries(); }
                        });
                    }; readEntries();
                });
            }
        }

        function isImageFile(fileName) {
            const name = fileName.toLowerCase();
            return name.endsWith('.webp') || name.endsWith('.jpg') || name.endsWith('.jpeg') || name.endsWith('.png') || name.endsWith('.gif') || name.endsWith('.bmp') || name.endsWith('.avif') || name.endsWith('.svg') || name.endsWith('.mp4') || name.endsWith('.webm');
        }
        function isVideoFile(fileName) { const name = fileName.toLowerCase(); return name.endsWith('.mp4') || name.endsWith('.webm'); }

        async function loadImages(files) {
            imageFiles = files.sort((a, b) => a.name.localeCompare(b.name, undefined, { numeric: true })).map(file => ({ url: URL.createObjectURL(file), file: file, name: file.name }));
            console.log(`ì´ ${imageFiles.length}ê°œì˜ ì´ë¯¸ì§€ë¥¼ ë¡œë“œí–ˆìŠµë‹ˆë‹¤.`);
            currentIndex = 0; thumbnailCache.clear();

            if (currentFolderHandle) {
                try { thumbFolderHandle = await currentFolderHandle.getDirectoryHandle('thumb', { create: false }); } catch (err) { thumbFolderHandle = null; }
            } else { thumbFolderHandle = null; }

            dropZone.classList.add('hidden');
            prevBtn.style.display = 'flex'; nextBtn.style.display = 'flex'; controlsSection.style.display = 'flex'; controlTrigger.style.display = 'block';
            showImage(currentIndex);

            setTimeout(() => { createThumbnails(); }, 100);
            setupControlsAutoHide();
        }

        // íˆìŠ¤í† ë¦¬ ë° UI ê´€ë ¨ í•¨ìˆ˜ë“¤ (ë³€ê²½ ì—†ìŒ)
        function saveFolderHistory() {
            if (!currentFolderData) return;
            try {
                let savedHistory = localStorage.getItem('imageGalleryHistory'); folderHistory = savedHistory ? JSON.parse(savedHistory) : [];
                folderHistory = folderHistory.filter(item => item.name !== currentFolderData.name);
                folderHistory.unshift({ name: currentFolderData.name, timestamp: currentFolderData.timestamp, count: currentFolderData.count });
                if (folderHistory.length > 20) folderHistory = folderHistory.slice(0, 20);
                localStorage.setItem('imageGalleryHistory', JSON.stringify(folderHistory)); renderFolderHistory();
            } catch (e) { console.error('íˆìŠ¤í† ë¦¬ ì €ì¥ ì‹¤íŒ¨:', e); }
        }
        function renderFolderHistory() {
            try {
                const savedHistory = localStorage.getItem('imageGalleryHistory'); folderHistory = savedHistory ? JSON.parse(savedHistory) : [];
                if (folderHistory.length === 0) { historyList.innerHTML = '<div class="no-history">ì•„ì§ ë³¸ í´ë”ê°€ ì—†ìŠµë‹ˆë‹¤.<br>ì¢Œì¸¡ì— í´ë”ë¥¼ ë“œë˜ê·¸í•´ì£¼ì„¸ìš”.</div>'; return; }
                historyList.innerHTML = '';
                folderHistory.forEach((folder, index) => {
                    const item = document.createElement('div'); item.className = 'history-item';
                    const date = new Date(folder.timestamp); const dateStr = `${date.getMonth() + 1}/${date.getDate()} ${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;
                    const displayName = folder.name.includes('\\') || folder.name.includes('/') ? folder.name : `ğŸ“ ${folder.name}`;
                    item.innerHTML = `<div class="history-item-name">${displayName}</div><div class="history-item-info">ì´ë¯¸ì§€: ${folder.count}ê°œ</div><div class="history-item-info">ë‚ ì§œ: ${dateStr}</div><button class="history-item-delete" data-index="${index}">âœ•</button>`;
                    item.addEventListener('click', (e) => { if (e.target.classList.contains('history-item-delete')) return; alert(`ğŸ“ "${folder.name}" í´ë”ë¥¼ ë‹¤ì‹œ ë³´ë ¤ë©´:\n\n1. í•´ë‹¹ í´ë”ë¥¼ ì°¾ì•„ì£¼ì„¸ìš”\n2. ì¢Œì¸¡ ì˜ì—­ì— í´ë”ë¥¼ ë“œë˜ê·¸ ì•¤ ë“œë¡­í•˜ì„¸ìš”`); });
                    historyList.appendChild(item);
                });
                document.querySelectorAll('.history-item-delete').forEach(btn => { btn.addEventListener('click', (e) => { e.stopPropagation(); deleteFolderHistory(parseInt(btn.dataset.index)); }); });
            } catch (e) { historyList.innerHTML = '<div class="no-history">íˆìŠ¤í† ë¦¬ ë¡œë“œ ì‹¤íŒ¨</div>'; }
        }
        function deleteFolderHistory(index) { folderHistory.splice(index, 1); localStorage.setItem('imageGalleryHistory', JSON.stringify(folderHistory)); renderFolderHistory(); }

        function setupControlsAutoHide() {
            controlTrigger.addEventListener('mouseenter', showControls);
            controlsSection.addEventListener('mouseenter', () => { clearTimeout(hideControlsTimeout); showControls(); });
            controlsSection.addEventListener('mouseleave', () => { clearTimeout(hideControlsTimeout); hideControlsTimeout = setTimeout(hideControls, 300); });
        }
        function showControls() { controlsSection.classList.remove('hidden'); clearTimeout(hideControlsTimeout); }
        function hideControls() { controlsSection.classList.add('hidden'); }

        function createThumbnails() {
            thumbnailContainer.innerHTML = '';
            const thumbElements = [];
            imageFiles.forEach((imgData, index) => {
                const thumb = document.createElement('img'); thumb.className = 'thumbnail';
                thumb.src = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7';
                thumb.addEventListener('click', () => { currentIndex = index; showImage(currentIndex); updateThumbnails(); });
                thumbnailContainer.appendChild(thumb); thumbElements.push(thumb);
            });
            updateThumbnails();
            processThumbnailsSequentially(thumbElements);
        }

        async function processThumbnailsSequentially(elements) {
            for (let i = 0; i < elements.length; i++) {
                const thumb = elements[i];
                const imgData = imageFiles[i];
                try {
                    const url = await createResizedThumbnail(imgData.url, imgData.name, imgData.file);
                    thumb.src = url;
                } catch (err) {
                    thumb.src = imgData.url;
                }
                await new Promise(r => setTimeout(r, 20));
            }
        }

        function updateThumbnails() {
            const thumbs = thumbnailContainer.querySelectorAll('.thumbnail');
            thumbs.forEach((thumb, index) => { thumb.classList.toggle('active', index === currentIndex); });
            const activeThumb = thumbs[currentIndex];
            if (activeThumb) {
                const thumbWidth = 130;
                const containerWidth = thumbnailContainer.parentElement.clientWidth - 120;
                const scrollPosition = (currentIndex * thumbWidth) - (containerWidth / 2) + (thumbWidth / 2);
                thumbnailContainer.scrollTo({ left: scrollPosition, behavior: 'smooth' });
            }
        }

        async function captureVideoFrame(video, time, maxWidth = 400) {
            return new Promise((resolve, reject) => {
                const onSeeked = () => {
                    try {
                        const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
                        const ratio = video.videoHeight / video.videoWidth; canvas.width = maxWidth; canvas.height = maxWidth * ratio;
                        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                        const iconSize = canvas.width / 4; ctx.fillStyle = 'rgba(0, 0, 0, 0.5)'; ctx.beginPath(); ctx.arc(canvas.width / 2, canvas.height / 2, iconSize / 2 + 5, 0, Math.PI * 2); ctx.fill(); ctx.fillStyle = 'white'; ctx.beginPath(); ctx.moveTo(canvas.width / 2 - iconSize / 4, canvas.height / 2 - iconSize / 2); ctx.lineTo(canvas.width / 2 + iconSize / 2, canvas.height / 2); ctx.lineTo(canvas.width / 2 - iconSize / 4, canvas.height / 2 + iconSize / 2); ctx.fill();
                        resolve(canvas.toDataURL('image/jpeg', 0.8));
                    } catch (e) { reject(e); }
                };
                video.onseeked = onSeeked; video.currentTime = time;
            });
        }

        function createFallbackVideoIcon() {
            const canvas = document.createElement('canvas'); canvas.width = 120; canvas.height = 80;
            const ctx = canvas.getContext('2d'); ctx.fillStyle = '#333'; ctx.fillRect(0, 0, 120, 80);
            ctx.fillStyle = 'white'; ctx.font = '24px Arial'; ctx.textAlign = 'center'; ctx.fillText('VIDEO', 60, 48);
            return canvas.toDataURL('image/jpeg');
        }

        async function createResizedThumbnail(imageUrl, originalFileName, fileObj, maxWidth = 400) {
            if (thumbnailCache.has(imageUrl)) return thumbnailCache.get(imageUrl);

            if (thumbFolderHandle && originalFileName) {
                try {
                    const thumbFileName = getThumbFileName(originalFileName);
                    const thumbFileHandle = await thumbFolderHandle.getFileHandle(thumbFileName);
                    const file = await thumbFileHandle.getFile();
                    const thumbUrl = URL.createObjectURL(file);
                    thumbnailCache.set(imageUrl, thumbUrl);
                    return thumbUrl;
                } catch (err) { }
            }

            if (!isVideoFile(originalFileName) && window.createImageBitmap && fileObj) {
                try {
                    const bitmap = await createImageBitmap(fileObj);
                    const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
                    const ratio = bitmap.height / bitmap.width; canvas.width = maxWidth; canvas.height = maxWidth * ratio;
                    ctx.drawImage(bitmap, 0, 0, canvas.width, canvas.height);
                    bitmap.close();
                    const thumbnailUrl = canvas.toDataURL('image/jpeg', 0.8);
                    thumbnailCache.set(imageUrl, thumbnailUrl);
                    return thumbnailUrl;
                } catch (e) { console.warn("Bitmap failed", e); }
            }

            if (isVideoFile(originalFileName)) {
                const video = document.createElement('video'); video.src = imageUrl; video.muted = true; video.playsInline = true; video.preload = 'metadata';
                return new Promise(async (resolve, reject) => {
                    const cleanup = () => { video.src = ""; video.load(); };
                    video.onloadedmetadata = async () => {
                        try {
                            const targetTime = Math.min(1, video.duration / 2);
                            const attempt1 = new Promise((res, rej) => {
                                const timer = setTimeout(() => rej('timeout'), 1500);
                                captureVideoFrame(video, targetTime, maxWidth).then(url => { clearTimeout(timer); res(url); }).catch(rej);
                            });
                            const url = await attempt1; thumbnailCache.set(imageUrl, url); resolve(url);
                        } catch (e) {
                            try {
                                const url = await captureVideoFrame(video, 0, maxWidth); thumbnailCache.set(imageUrl, url); resolve(url);
                            } catch (finalErr) {
                                const fallbackUrl = createFallbackVideoIcon(); thumbnailCache.set(imageUrl, fallbackUrl); resolve(fallbackUrl);
                            }
                        } finally { cleanup(); }
                    };
                    video.onerror = () => { cleanup(); resolve(createFallbackVideoIcon()); };
                });
            }

            return new Promise((resolve, reject) => {
                let img = new Image(); img.decoding = 'async';
                img.onload = function () {
                    const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
                    const ratio = img.height / img.width; canvas.width = maxWidth; canvas.height = maxWidth * ratio;
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    const thumbnailUrl = canvas.toDataURL('image/jpeg', 0.8); thumbnailCache.set(imageUrl, thumbnailUrl); resolve(thumbnailUrl);
                    img = null;
                };
                img.onerror = () => { reject(new Error('Image Error')); };
                img.src = imageUrl;
            });
        }

        function getThumbFileName(originalFileName) { const nameWithoutExt = originalFileName.replace(/\.[^/.]+$/, ''); return `thumb_${nameWithoutExt}.jpg`; }

        async function createThumbnailGrid() {
            thumbnailGrid.innerHTML = ''; modalCount.textContent = imageFiles.length; modalDownload.disabled = true; modalDownload.textContent = 'ğŸ’¾ ìƒì„± ì¤‘...';
            let loadedCount = 0;
            const loadingTextDiv = document.createElement('div');
            loadingTextDiv.style.cssText = 'color: white; text-align: center; padding: 20px; grid-column: 1/-1; position: absolute; top: 0; width: 100%; pointer-events: none;';
            loadingTextDiv.textContent = `ì¸ë„¤ì¼ ë¡œë“œ ì¤‘... 0/${imageFiles.length}`;
            thumbnailGrid.parentElement.appendChild(loadingTextDiv);

            const gridItems = [];
            for (let index = 0; index < imageFiles.length; index++) {
                const imgData = imageFiles[index];
                const gridItem = document.createElement('div'); gridItem.className = 'grid-item'; gridItem.dataset.index = index;
                if (index === currentIndex) gridItem.classList.add('current');
                const img = document.createElement('img'); img.src = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7'; img.loading = 'lazy'; img.style.transition = 'opacity 0.3s ease'; img.style.opacity = '0.3';
                const number = document.createElement('div'); number.className = 'grid-item-number'; number.textContent = index + 1;
                gridItem.appendChild(img); gridItem.appendChild(number);
                gridItem.addEventListener('click', () => { currentIndex = index; showImage(currentIndex); closeThumbnailModal(); });
                gridItem.addEventListener('mouseenter', () => focusGridItem(index));
                thumbnailGrid.appendChild(gridItem); gridItems.push({ item: gridItem, img: img, data: imgData });
            }

            for (let i = 0; i < gridItems.length; i++) {
                const { img, data } = gridItems[i];
                try {
                    const thumbnailUrl = await createResizedThumbnail(data.url, data.name, data.file, 400);
                    img.src = thumbnailUrl; img.style.opacity = '1';
                } catch (err) {
                    img.src = data.url; img.style.opacity = '1';
                }
                loadedCount++;
                if (loadedCount % 10 === 0) loadingTextDiv.textContent = `ì¸ë„¤ì¼ ë¡œë“œ ì¤‘... ${loadedCount}/${imageFiles.length}`;
                await new Promise(r => setTimeout(r, 5));
            }

            modalDownload.disabled = false; modalDownload.textContent = 'ğŸ’¾ ì¸ë„¤ì¼ ë‹¤ìš´ë¡œë“œ (ZIP)';
            loadingTextDiv.remove();
            setTimeout(() => {
                focusGridItem(currentIndex);
                const currentItem = thumbnailGrid.querySelector('.grid-item.current');
                if (currentItem) currentItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 100);
        }

        async function downloadAllThumbnails() { await downloadThumbnailsAsZip(); }

        async function downloadThumbnailsAsZip() {
            if (typeof JSZip === 'undefined') { alert('ì••ì¶• ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ì‹¤íŒ¨.'); return; }
            if (thumbnailCache.size === 0) { alert('ì €ì¥í•  ì¸ë„¤ì¼ì´ ì—†ìŠµë‹ˆë‹¤.'); return; }
            modalDownload.disabled = true; modalDownload.textContent = 'ğŸ“¦ ì¤€ë¹„ ì¤‘...';
            try {
                const zip = new JSZip(); const folder = zip; const totalFiles = imageFiles.length; let processedCount = 0;
                for (let i = 0; i < totalFiles; i++) {
                    const imgData = imageFiles[i]; const thumbnailUrl = thumbnailCache.get(imgData.url);
                    if (thumbnailUrl) { const base64Data = thumbnailUrl.split(',')[1]; const fileName = getThumbFileName(imgData.name); folder.file(fileName, base64Data, { base64: true }); }
                    processedCount++; if (processedCount % 10 === 0) { modalDownload.textContent = `ğŸ“¦ ì••ì¶• ì¤‘... ${processedCount}/${totalFiles}`; await new Promise(r => setTimeout(r, 0)); }
                }
                modalDownload.textContent = 'ğŸ“¦ ZIP íŒŒì¼ ìƒì„± ì¤‘...'; const content = await zip.generateAsync({ type: "blob" });

                if (currentFolderHandle && window.showDirectoryPicker) {
                    try {
                        modalDownload.textContent = 'ğŸ’¾ í´ë”ì— ì €ì¥ ì¤‘...';
                        const fileHandle = await currentFolderHandle.getFileHandle('thumb.zip', { create: true });
                        const writable = await fileHandle.createWritable(); await writable.write(content); await writable.close();
                        alert('âœ… thumb.zip íŒŒì¼ì´ í˜„ì¬ í´ë”ì— ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!'); modalDownload.textContent = 'ğŸ’¾ ì¸ë„¤ì¼ ë‹¤ìš´ë¡œë“œ'; modalDownload.disabled = false; return;
                    } catch (e) { console.error('í´ë” ì €ì¥ ì‹¤íŒ¨', e); }
                }
                const url = URL.createObjectURL(content); const a = document.createElement("a"); a.href = url; a.download = "thumb.zip"; document.body.appendChild(a); a.click(); document.body.removeChild(a); setTimeout(() => URL.revokeObjectURL(url), 1000);
                modalDownload.textContent = 'ğŸ’¾ ì¸ë„¤ì¼ ë‹¤ìš´ë¡œë“œ'; modalDownload.disabled = false;
                if (!currentFolderHandle) alert('thumb.zip íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œ í´ë”ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
            } catch (e) { alert('ì˜¤ë¥˜ ë°œìƒ: ' + e.message); modalDownload.textContent = 'ğŸ’¾ ì¸ë„¤ì¼ ë‹¤ìš´ë¡œë“œ'; modalDownload.disabled = false; }
        }

        function openThumbnailModal() {
            thumbnailModal.classList.add('active');
            document.body.style.overflow = 'hidden';
            if (thumbnailGrid.children.length === 0) {
                createThumbnailGrid();
            } else {
                updateGridCurrentItem();
                setTimeout(() => {
                    focusGridItem(currentIndex);
                    const currentItem = thumbnailGrid.querySelector('.grid-item.current');
                    if (currentItem) currentItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 50);
            }
            thumbnailModal.focus();
        }

        function closeThumbnailModal() { thumbnailModal.classList.remove('active'); document.body.style.overflow = ''; focusedGridIndex = -1; }
        function updateGridCurrentItem() { const items = thumbnailGrid.querySelectorAll('.grid-item'); items.forEach((item, index) => { item.classList.toggle('current', index === currentIndex); }); }

        function focusGridItem(index) {
            if (index < 0 || index >= imageFiles.length) return;
            focusedGridIndex = index;
            const items = thumbnailGrid.querySelectorAll('.grid-item');
            items.forEach((item, i) => {
                if (i === index) item.classList.add('focused');
                else item.classList.remove('focused');
            });
        }

        function navigateGrid(direction) {
            if (focusedGridIndex === -1) focusedGridIndex = currentIndex;
            const firstItem = thumbnailGrid.querySelector('.grid-item');
            if (!firstItem) return;
            const gridStyle = window.getComputedStyle(thumbnailGrid);
            const gridWidth = thumbnailGrid.clientWidth;
            const gap = parseFloat(gridStyle.gap) || 20;
            const itemWidth = firstItem.offsetWidth;
            const columns = Math.floor((gridWidth + gap) / (itemWidth + gap));

            let newIndex = focusedGridIndex;
            switch (direction) {
                case 'left': newIndex = Math.max(0, focusedGridIndex - 1); break;
                case 'right': newIndex = Math.min(imageFiles.length - 1, focusedGridIndex + 1); break;
                case 'up': newIndex = Math.max(0, focusedGridIndex - columns); break;
                case 'down': newIndex = Math.min(imageFiles.length - 1, focusedGridIndex + columns); break;
            }

            if (newIndex !== focusedGridIndex) {
                focusGridItem(newIndex);
                const items = thumbnailGrid.querySelectorAll('.grid-item');
                items[newIndex].scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }

        function scrollThumbnails(direction) { const scrollAmount = 400; if (direction === 'left') thumbnailContainer.scrollBy({ left: -scrollAmount, behavior: 'smooth' }); else thumbnailContainer.scrollBy({ left: scrollAmount, behavior: 'smooth' }); }

        function showImage(index) {
            if (imageFiles.length === 0) return;
            zoomLevel = 1; translateX = 0; translateY = 0;
            const item = imageFiles[index]; const isVideo = isVideoFile(item.name); let mediaEl;
            if (isVideo) { mediaEl = document.createElement('video'); mediaEl.controls = true; mediaEl.loop = true; mediaEl.autoplay = true; mediaEl.style.maxHeight = 'calc(100vh - 450px)'; } else { mediaEl = document.createElement('img'); }
            mediaEl.className = 'gallery-image fade'; mediaEl.src = item.url;
            mediaEl.onload = mediaEl.onloadeddata = function () { imageWrapper.innerHTML = ''; imageWrapper.appendChild(mediaEl); setTimeout(() => mediaEl.classList.remove('fade'), 10); if (!isVideo) setupImageEvents(mediaEl); };
            mediaEl.onerror = function () { imageWrapper.innerHTML = '<div class="loading">íŒŒì¼ ë¡œë”© ì‹¤íŒ¨</div>'; };
            counter.textContent = `${index + 1} / ${imageFiles.length}`; updateThumbnails();
        }

        function setupImageEvents(img) {
            img.addEventListener('wheel', (e) => { e.preventDefault(); const delta = e.deltaY > 0 ? -0.1 : 0.1; zoomLevel = Math.max(0.5, Math.min(5, zoomLevel + delta)); updateImageTransform(img); showZoomInfo(); });
            img.addEventListener('mousedown', (e) => { if (zoomLevel > 1) { isPanning = true; startX = e.clientX - translateX; startY = e.clientY - translateY; img.style.cursor = 'grabbing'; } });
            document.addEventListener('mousemove', (e) => { if (isPanning && zoomLevel > 1) { translateX = e.clientX - startX; translateY = e.clientY - startY; updateImageTransform(img); } });
            document.addEventListener('mouseup', () => { if (isPanning) { isPanning = false; img.style.cursor = 'grab'; } });
        }
        function updateImageTransform(img) { if (zoomLevel === 1) { translateX = 0; translateY = 0; } img.style.transform = `scale(${zoomLevel}) translate(${translateX / zoomLevel}px, ${translateY / zoomLevel}px)`; }
        function showZoomInfo() { zoomInfo.textContent = `${Math.round(zoomLevel * 100)}%`; zoomInfo.style.display = 'block'; clearTimeout(window.zoomInfoTimeout); window.zoomInfoTimeout = setTimeout(() => { zoomInfo.style.display = 'none'; }, 1500); }

        function prevImage() { if (imageFiles.length === 0) return; currentIndex = (currentIndex - 1 + imageFiles.length) % imageFiles.length; showImage(currentIndex); }
        function nextImage() { if (imageFiles.length === 0) return; currentIndex = (currentIndex + 1) % imageFiles.length; showImage(currentIndex); }
        function startAutoplay() { if (isAutoplay) return; isAutoplay = true; autoplayBtn.textContent = 'â¸ ì¼ì‹œì •ì§€'; autoplayBtn.classList.add('active'); autoplayInterval = setInterval(nextImage, playSpeed); }
        function stopAutoplay() { if (!isAutoplay) return; isAutoplay = false; autoplayBtn.textContent = 'â–¶ ìë™ì¬ìƒ'; autoplayBtn.classList.remove('active'); clearInterval(autoplayInterval); showControls(); }
        function toggleAutoplay() { if (imageFiles.length === 0) return; if (isAutoplay) stopAutoplay(); else startAutoplay(); }
        function toggleFullscreen() { if (!document.fullscreenElement) { document.documentElement.requestFullscreen(); fullscreenBtn.textContent = 'ğŸ–¥ï¸ ì „ì²´í™”ë©´ ì¢…ë£Œ'; hideControls(); } else { document.exitFullscreen(); fullscreenBtn.textContent = 'ğŸ–¥ï¸ ì „ì²´í™”ë©´'; showControls(); } }
        document.addEventListener('fullscreenchange', () => { if (!document.fullscreenElement) fullscreenBtn.textContent = 'ğŸ–¥ï¸ ì „ì²´í™”ë©´'; });

        prevBtn.addEventListener('click', prevImage); nextBtn.addEventListener('click', nextImage); autoplayBtn.addEventListener('click', toggleAutoplay); fullscreenBtn.addEventListener('click', toggleFullscreen); thumbnailGridBtn.addEventListener('click', openThumbnailModal); uploadBtn.addEventListener('click', () => { window.location.href = window.location.href; }); modalClose.addEventListener('click', closeThumbnailModal); modalDownload.addEventListener('click', downloadAllThumbnails); thumbPrev.addEventListener('click', () => scrollThumbnails('left')); thumbNext.addEventListener('click', () => scrollThumbnails('right'));
        speedButtons.forEach(btn => { btn.addEventListener('click', () => { speedButtons.forEach(b => b.classList.remove('active')); btn.classList.add('active'); playSpeed = parseInt(btn.dataset.speed); if (isAutoplay) { clearInterval(autoplayInterval); autoplayInterval = setInterval(nextImage, playSpeed); } }); });

        document.addEventListener('keydown', function (e) {
            if (thumbnailModal.classList.contains('active')) {
                if (e.key === 'Escape') { e.preventDefault(); closeThumbnailModal(); return; }
                if (['ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown'].includes(e.key)) { e.preventDefault(); navigateGrid(e.key.replace('Arrow', '').toLowerCase()); return; }
                if (e.key === 'PageDown') {
                    e.preventDefault();
                    const gridWidth = thumbnailGrid.clientWidth; const firstItem = thumbnailGrid.querySelector('.grid-item');
                    if (firstItem) {
                        const itemWidth = firstItem.offsetWidth; const columns = Math.floor(gridWidth / itemWidth) || 1;
                        let newIndex = Math.min(imageFiles.length - 1, focusedGridIndex + (columns * 3));
                        if (newIndex !== focusedGridIndex) { focusedGridIndex = newIndex; focusGridItem(newIndex); thumbnailGrid.querySelectorAll('.grid-item')[newIndex].scrollIntoView({ behavior: 'smooth', block: 'center' }); }
                    }
                    return;
                }
                if (e.key === 'PageUp') {
                    e.preventDefault();
                    const gridWidth = thumbnailGrid.clientWidth; const firstItem = thumbnailGrid.querySelector('.grid-item');
                    if (firstItem) {
                        const itemWidth = firstItem.offsetWidth; const columns = Math.floor(gridWidth / itemWidth) || 1;
                        let newIndex = Math.max(0, focusedGridIndex - (columns * 3));
                        if (newIndex !== focusedGridIndex) { focusedGridIndex = newIndex; focusGridItem(newIndex); thumbnailGrid.querySelectorAll('.grid-item')[newIndex].scrollIntoView({ behavior: 'smooth', block: 'center' }); }
                    }
                    return;
                }
                if (e.key === 'Home') { e.preventDefault(); focusedGridIndex = 0; focusGridItem(0); thumbnailModal.scrollTo({ top: 0, behavior: 'smooth' }); return; }
                if (e.key === 'End') { e.preventDefault(); focusedGridIndex = imageFiles.length - 1; focusGridItem(focusedGridIndex); thumbnailGrid.querySelectorAll('.grid-item')[focusedGridIndex].scrollIntoView({ behavior: 'smooth', block: 'center' }); return; }
                if (e.key === 'Enter') { e.preventDefault(); if (focusedGridIndex >= 0) { currentIndex = focusedGridIndex; showImage(currentIndex); closeThumbnailModal(); } return; }
                return;
            }
            if (e.ctrlKey && e.key === 'Enter') { e.preventDefault(); if (!document.fullscreenElement) toggleFullscreen(); }
            else if (e.key === 'ArrowLeft') prevImage(); else if (e.key === 'ArrowRight') nextImage();
            else if (e.key === 'ArrowUp') { e.preventDefault(); startAutoplay(); } else if (e.key === 'ArrowDown') { e.preventDefault(); stopAutoplay(); }
            else if (e.key === ' ') { e.preventDefault(); toggleAutoplay(); }
            else if (e.key === 'PageDown') { e.preventDefault(); nextImage(); } else if (e.key === 'PageUp') { e.preventDefault(); prevImage(); }
        });

        window.addEventListener('beforeunload', function () { if (autoplayInterval) clearInterval(autoplayInterval); });
        renderFolderHistory();
    </script>
</body>

</html>